{% extends "layout.html" %}

{% block content %}
  <section class="card">
    <h2>인플루언서 서칭</h2>
    <form method="get" class="form inline">
      <input
        type="text"
        name="q"
        value="{{ q }}"
        placeholder="검색 (이름/계정명, 카테고리, 이메일, 비고 등)"
      />
      <select name="platform">
        <option value="">플랫폼 전체</option>
        {% for p in platforms %}
          <option value="{{ p }}" {% if p == platform %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
      <select name="category_main">
        <option value="">카테고리(대) 전체</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if c == category_main %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <select name="category_sub">
        <option value="">카테고리(소) 전체</option>
        {% for c in sub_categories %}
          <option value="{{ c }}" {% if c == category_sub %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      {% for col in selected_columns %}
        <input type="hidden" name="columns" value="{{ col }}" />
      {% endfor %}
      <button class="button">검색</button>
      <a class="button ghost" href="{{ url_for('search') }}">초기화</a>
      <a
        class="button ghost"
        href="{{ url_for('export_excel', q=q, platform=platform, category_main=category_main, category_sub=category_sub, columns=(','.join(selected_columns))) }}"
      >
        엑셀 내보내기
      </a>
    </form>
  </section>

  <section class="card">
    <form method="get" class="form">
      <div class="column-picker">
        {% for col in all_columns %}
          <label class="checkbox">
            <input
              type="checkbox"
              name="columns"
              value="{{ col }}"
              {% if col in selected_columns %}checked{% endif %}
            />
            <span>{{ column_labels[col] }}</span>
          </label>
        {% endfor %}
      </div>
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="platform" value="{{ platform }}" />
      <input type="hidden" name="category_main" value="{{ category_main }}" />
      <input type="hidden" name="category_sub" value="{{ category_sub }}" />
      <button class="button">컬럼 적용</button>
    </form>
  </section>

  <section class="table-wrap">
    <table>
      <thead>
        <tr>
          {% for col in selected_columns %}
            <th>{{ column_labels[col] }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in influencers %}
          <tr>
            {% for col in selected_columns %}
              <td>
                {% if col == "thumbnail_url" and row[col] %}
                  <img src="{{ row[col] }}" alt="썸네일" class="thumb" loading="lazy" />
                {% elif col == "profile_url" and row[col] %}
                  <a href="{{ row[col] }}" target="_blank" rel="noopener noreferrer">프로필 열기</a>
                {% elif col == "instagram_username" and row[col] %}
                  <a href="https://www.instagram.com/{{ row[col] }}/" target="_blank" rel="noopener noreferrer">
                    @{{ row[col] }}
                  </a>
                {% elif col == "contact_email" and row[col] %}
                  <a href="mailto:{{ row[col] }}">{{ row[col] }}</a>
                {% elif col == "dm_message" and row[col] %}
                  {% set dm_rendered = row[col] %}
                  {% set dm_rendered = dm_rendered|replace("{이름}", row.account_name or "") %}
                  {% set dm_rendered = dm_rendered|replace("{인스타그램아이디}", row.instagram_username or "") %}
                  {% set dm_rendered = dm_rendered|replace("{플랫폼}", row.platform or "") %}
                  {% set dm_rendered = dm_rendered|replace("{프로필URL}", row.profile_url or "") %}
                  {{ dm_rendered }}
                {% else %}
                  {{ row[col] }}
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% else %}
          <tr>
            <td colspan="{{ selected_columns|length }}" class="empty">표시할 데이터가 없습니다.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
